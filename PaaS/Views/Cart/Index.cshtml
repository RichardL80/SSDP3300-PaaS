@model IEnumerable<CartItem>

@{
    ViewData["Title"] = "Cart";
}

<div class="cart-container">
    <h1>My Cart</h1>
    <a id="cart" class="nav-link" asp-area="" asp-controller="Menu" asp-action="Index">+ Add More</a>
    <div id="cart-items">
        @foreach (var item in Model)
        {
            <div class="cart-item" data-id="@item.Item.ItemId">
                <img src="@item.Item.ImgUrl" alt="@item.Item.Name Image" width="100" height="100">  
                <h3>@item.Item.Name</h3>
                <div>@item.Item.Price</div>
                <button class="btn btn-danger remove-from-cart" data-id="@item.Item.ItemId">-</button>
                <span> @item.Quantity </span>
                <button class="btn btn-primary add-to-cart" data-id="@item.Item.ItemId">+</button>
                <div>@((item.Quantity*item.Item.Price).ToString("C")) </div>
                <button class="btn btn-danger delete-from-cart" data-id="@item.Item.ItemId">Delete</button>   
            </div>
        }
    </div>
    <div class="cart-total">
        <h3>Total: @Model.Sum(x => x.Quantity * x.Item.Price).ToString("C")</h3>
    </div>
    <a class="checkout" asp-area="" asp-controller="PayPal" asp-action="Index">Checkout</a>
</div>

@section Scripts {
    <script>
        function updateCart() {
            fetch('@Url.Action("GetCartItems", "Cart")')
                .then(response => response.json())
                .then(data => {
                    const cartItemsContainer = document.getElementById('cart-items');
                    cartItemsContainer.innerHTML = '';
                    let total = 0;
                    data.forEach(item => {
                        const cartItem = document.createElement('div');
                        cartItem.classList.add('cart-item');
                        cartItem.setAttribute('data-id', item.item.itemId);
                        cartItem.innerHTML = `
                            <img src="${item.item.imgUrl}" alt="${item.item.name} Image" width="100" height="100">
                            <h3>${item.item.name}</h3>
                            <div>${item.item.price}</div>
                            <button class="btn btn-danger remove-from-cart" data-id="${item.item.itemId}">-</button>
                            <span>${item.quantity}</span>
                            <button class="btn btn-primary add-to-cart" data-id="${item.item.itemId}">+</button>
                            <div>${(item.quantity * item.item.price).toFixed(2)}</div>
                            <button class="btn btn-danger delete-from-cart" data-id="${item.item.itemId}">Delete</button>
                        `;
                        cartItemsContainer.appendChild(cartItem);
                        total += item.quantity * item.item.price;
                    });
                    document.querySelector('.cart-total h3').innerText = `Total: ${total.toFixed(2)}`;
                    attachEventListeners();
                });
        }

        function attachEventListeners() {
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    fetch('@Url.Action("AddToCartAjax", "Cart")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ itemId: parseInt(itemId) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateCart();
                        } else {
                            console.log('Failed to add item to cart');
                        }
                    });
                });
            });

            document.querySelectorAll('.delete-from-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    fetch('@Url.Action("DeleteFromCartAjax", "Cart")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ itemId: parseInt(itemId) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateCart();
                        } else {
                            console.log('Failed to delete item from cart');
                        }
                    });
                });
            });

            document.querySelectorAll('.remove-from-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    fetch('@Url.Action("RemoveFromCartAjax", "Cart")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ itemId: parseInt(itemId) })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateCart();
                        } else {
                            console.log('Failed to remove item from cart');
                        }
                    });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            attachEventListeners();
        });
    </script>
}